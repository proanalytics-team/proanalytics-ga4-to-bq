___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "GA4 Data Export to BigQuery",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "categories": [
    "ANALYTICS",
    "DATA_WAREHOUSING"
  ],
  "description": "Send events to BigQuery using the Streaming Insert API. The table schema configuration can be found from the tag\u0027s GitHub page:",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "bqProject",
    "displayName": "BigQuery Project Id",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "help": "The id of the BigQuery project where the data is sent to."
  },
  {
    "type": "TEXT",
    "name": "bqDataset",
    "displayName": "BigQuery Dataset Id",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "help": "The id of the BigQuery dataset where the data is sent to."
  },
  {
    "type": "TEXT",
    "name": "bqTable",
    "displayName": "BigQuery Table Id",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "help": "The id of the BigQuery table where the data is sent to."
  },
  {
    "type": "TEXT",
    "name": "client_id",
    "displayName": "client_id",
    "simpleValueType": true,
    "help": "Writes the id in the \u003cstrong\u003euser_pseudo_id\u003c/strong\u003e string field."
  },
  {
    "type": "TEXT",
    "name": "session_id",
    "displayName": "ga_session_id",
    "simpleValueType": true,
    "help": "Writes the id in the \u003cstrong\u003ega_session_id\u003c/strong\u003e string field."
  },
  {
    "type": "TEXT",
    "name": "eventName",
    "displayName": "event_name",
    "simpleValueType": true,
    "help": "Writes the data in the \u003cstrong\u003eevent_name\u003c/strong\u003e string field."
  },
  {
    "type": "TEXT",
    "name": "original_fpid",
    "displayName": "original_fpid (optional)",
    "simpleValueType": true,
    "help": "By default, this field should remain empty. If you want to track the original FPID, you need to enter the Cookie value(FPID) variable here. Writes the id in the \u003cstrong\u003eoriginal_fpid\u003c/strong\u003e string field."
  },
  {
    "type": "TEXT",
    "name": "bqFallbackTable",
    "displayName": "BigQuery Table Id For Error Logs (optional)",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "help": "By default, this field should remain empty. If you modify the template, it’s best to create a separate table with a defined schema to ensure that data transmission to the main table is not disrupted."
  }
]


___SANDBOXED_JS_FOR_SERVER___

const log = require('logToConsole');
const BigQuery = require('BigQuery');
const makeString = require('makeString');
const makeInteger = require('makeInteger');
const JSON = require('JSON');
const getTimestampMillis = require('getTimestampMillis');
const getAllEventData = require('getAllEventData');
const getType = require('getType');
const Object = require('Object');
const Math = require("Math");

// Function to calculate the date in UTC (YYYY-MM-DD)
function calculateUTCDateFromTimestamp(timestampInMillis) {
  const secondsInDay = 86400;
  let timestampInSeconds = Math.floor(timestampInMillis / 1000);
  return calculateDateFromTimestamp(timestampInSeconds);
}

// Function to calculate the date in format YYYY-MM-DD
function calculateDateFromTimestamp(timestampInSeconds) {
  const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
  const epochYear = 1970;
  const secondsInDay = 86400;

  let daysSinceEpoch = Math.floor(timestampInSeconds / secondsInDay);
  let year = epochYear;

  while (daysSinceEpoch >= (isLeapYear(year) ? 366 : 365)) {
    daysSinceEpoch = daysSinceEpoch - (isLeapYear(year) ? 366 : 365);
    year = year + 1;
  }

  let month = 0;
  while (daysSinceEpoch >= (month === 1 && isLeapYear(year) ? 29 : daysInMonth[month])) {
    daysSinceEpoch = daysSinceEpoch - (month === 1 && isLeapYear(year) ? 29 : daysInMonth[month]);
    month = month + 1;
  }

  const day = daysSinceEpoch + 1;
  return year + "-" + padToTwoDigits(month + 1) + "-" + padToTwoDigits(day);
}

// Function to check if a year is a leap year
function isLeapYear(year) {
  return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
}

// Function to format a number to two digits
function padToTwoDigits(number) {
  return (number < 10 ? "0" : "") + number;
}



// Function to validate value
function isValidValue(value) {
  return value !== undefined && value !== null && value !== '';
}

// Function to identify data type
function identifyDataType(fieldValue) {
  if (typeof fieldValue === 'string') return 'string_value';
  if (typeof fieldValue === 'number') {
    return makeInteger(fieldValue) === fieldValue ? 'int_value' : 'float_value';
  }
  return 'string_value';
}

// Function to transform value into the appropriate format
function changeDataType(fieldValue) {
    if (fieldValue === undefined || fieldValue === null) {
        return null; // Return null if the value is undefined or null
    }
    if (typeof fieldValue === 'boolean') {
        return fieldValue ? 1 : 0; // Convert true → 1, false → 0
    }
    if (typeof fieldValue === 'object') {
        return JSON.stringify(fieldValue); // Convert objects to JSON string
    }
    return fieldValue; // Leave all other values unchanged
}


// Main object for insertion
const row = {
  event_date: calculateUTCDateFromTimestamp(getTimestampMillis()),
  event_timestamp: getTimestampMillis(),
  event_name: makeString(data.eventName),
  user_pseudo_id: makeString(data.client_id),
  ga_session_id: makeString(data.session_id),
  event_params: [],
  user_properties: [],
  items: []
};



// Predefined fields for items
const predefinedItemFields = [
  "item_id", 
  "item_name", 
  "item_brand", 
  "item_variant",
  "item_category", 
  "item_category2",
  "item_category3",
  "item_category4",
  "item_category5",
  "price_in_usd", 
  "price", 
  "quantity",
  "item_revenue_in_usd",
  "item_revenue",
  "item_refund_in_usd",
  "item_refund",
  "coupon", 
  "affiliation",
  "location_id",
  "item_list_id",
  "item_list_name",
  "item_list_index",
  "promotion_id",
  "promotion_name",
  "creative_name",
  "creative_slot"
];

// Function to process `items`
function extractItems(eventData) {
  if (!eventData.items || getType(eventData.items) !== 'array') {
    return;
  }

  eventData.items.forEach(function (item) {
    var processedItem = {};

    Object.keys(item).forEach(function (key) {
      var value = item[key];

      if (getType(predefinedItemFields) === 'array' && predefinedItemFields.indexOf(key) > -1) {
        processedItem[key] = isValidValue(value) ? changeDataType(value) : null;
      } 

      else if (isValidValue(value)) {
        var param = {
          key: key,
          value: {}
        };
        var fieldType = identifyDataType(value);

        if (fieldType === 'string_value') {
          param.value.string_value = changeDataType(value);
        } else if (fieldType === 'int_value') {
          param.value.int_value = changeDataType(value);
        } else if (fieldType === 'float_value') {
          param.value.float_value = changeDataType(value);
        }

        processedItem.item_params = processedItem.item_params || [];
        processedItem.item_params.push(param);
      }
    });

    row.items.push(processedItem);
  });
}


// Function to process `event_params`
function extractEventParams(eventData) {
  Object.keys(eventData).forEach((key) => {
    if (key !== 'items' && key !== 'x-ga-mp2-user_properties'&& key !== 'event_name' && key !== 'client_id' && key !== 'ga_session_id') {
      const value = eventData[key];
      if (isValidValue(value)) {
        const param = {
          key: key,
          value: {}
        };
        const fieldType = identifyDataType(value);
             
        

        // Явно задаємо ключ типу даних
        if (fieldType === 'string_value') {
          param.value.string_value = changeDataType(value);
        } else if (fieldType === 'int_value') {
          param.value.int_value = changeDataType(value);
        } else if (fieldType === 'float_value') {
          param.value.float_value = changeDataType(value);
        }

        row.event_params.push(param);
      }
    }
  });
  }

// Add original_fpid with processing
  if (data.original_fpid) {
    var rawFpid = data.original_fpid.replace("FPID2.2.", "");// Remove prefix FPID2.2.
    var decodedFpid = decodeURIComponentPolyfill(rawFpid);// Decode the value
    log("Processed original_fpid: " + decodedFpid);

    var originalFpidParam = { key: "original_fpid", value: {} };
    originalFpidParam.value.string_value = makeString(decodedFpid);
    row.event_params.push(originalFpidParam);
  } else {
    log("original_fpid is missing or undefined.");
  }

                               

// Function to decode encoded URI components
function decodeURIComponentPolyfill(encodedStr) {
  return encodedStr
    .split("%2B").join("+")
    .split("%2F").join("/")
    .split("%3D").join("=")
    .split("%20").join(" ")
    .split("%3A").join(":")
    .split("%2C").join(",")
    .split("%3B").join(";")
    .split("%40").join("@");
}

// Processing `user_properties`
function extractUserProperties(eventData) {
  if (
    eventData['x-ga-mp2-user_properties'] &&
    typeof eventData['x-ga-mp2-user_properties'] === 'object'
  ) {
    const userProps = eventData['x-ga-mp2-user_properties'];
    Object.keys(userProps).forEach((key) => {
      const value = userProps[key];
      if (isValidValue(value)) {
        const param = {
          key: key,
          value: {}
        };
        const fieldType = identifyDataType(value);

         // Explicitly assign data type key
        if (fieldType === 'string_value') {
          param.value.string_value = changeDataType(value);
        } else if (fieldType === 'int_value') {
          param.value.int_value = changeDataType(value);
        } else if (fieldType === 'float_value') {
          param.value.float_value = changeDataType(value);
        }

        row.user_properties.push(param);
      }
    });
  }
}

// Retrieve all event data
const eventData = getAllEventData();
if (eventData && typeof eventData === 'object') {
  
   
  extractItems(eventData);
  extractEventParams(eventData);
  extractUserProperties(eventData);
}

// Log the final object
log("Final row: " + JSON.stringify(row));

// BigQuery configuration
const connectionInfo = {
  projectId: data.bqProject,
  datasetId: data.bqDataset,
  tableId: data.bqTable
};
// BigQuery configuration (error logs)
const connectionInfoFallback = {
  projectId: data.bqProject,
  datasetId: data.bqDataset,
  tableId: data.bqFallbackTable // table name for logs(the same datasetId)
};

const options = { ignoreUnknownValues: true };


BigQuery.insert(connectionInfo, [row], options, data.gtmOnSuccess, (err) => {
  if (err) {
    log("BigQuery insert error: " + JSON.stringify(err));
    const rowFallback = {
  timestamp: Math.ceil(getTimestampMillis() / 1000),
  logs: JSON.stringify(err)
};
    BigQuery.insert(connectionInfoFallback, [rowFallback], options, data.gtmOnSuccess, (err) => {
  if (err) {
    log("BigQuery insert error: " + JSON.stringify(err));
    data.gtmOnFailure();
  } else {
    log("BigQuery InfoFallback insert successful");
    data.gtmOnSuccess();
  }
});
    data.gtmOnFailure();
  } else {
    log("BigQuery insert successful");
    data.gtmOnSuccess();
  }
});


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_bigquery",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedTables",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "datasetId"
                  },
                  {
                    "type": 1,
                    "string": "tableId"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 20.02.2025, 16:49:09


